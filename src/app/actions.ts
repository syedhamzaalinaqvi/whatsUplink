'use server';

import { z } from 'zod';
import { extractGroupInfoFromLink } from '@/ai/flows/extract-group-info-from-link';
import type { GroupLink } from '@/lib/data';

const submitGroupSchema = z.object({
  link: z.string().url('Please enter a valid WhatsApp group link'),
  category: z.string().min(1, 'Please select a category'),
  country: z.string().min(1, 'Please select a country'),
  tags: z.string().optional(),
});

export type FormState = {
  message: string;
  group?: GroupLink;
  errors?: {
    link?: string[];
    category?: string[];
    country?: string[];
    tags?: string[];
  };
};

export async function submitGroup(
  prevState: FormState,
  formData: FormData
): Promise<FormState> {
  const validatedFields = submitGroupSchema.safeParse({
    link: formData.get('link'),
    category: formData.get('category'),
    country: formData.get('country'),
    tags: formData.get('tags'),
  });

  if (!validatedFields.success) {
    return {
      message: 'Validation failed. Please check your input.',
      errors: validatedFields.error.flatten().fieldErrors,
    };
  }

  const { link, category, country, tags } = validatedFields.data;

  try {
    const { title, description, previewImage } = await extractGroupInfoFromLink({
      groupLink: link,
    });

    const newGroup: GroupLink = {
      id: new Date().toISOString(), // In a real app, this would be generated by Firestore
      title,
      description,
      link,
      imageUrl: previewImage,
      imageHint: 'AI generated',
      category,
      country,
      tags: tags ? tags.split(',').map(tag => tag.trim()).filter(Boolean) : [],
    };

    // Here you would save the `newGroup` to Firestore.
    // For this example, we'll return it to the client to be displayed.
    return {
      message: 'Group submitted successfully!',
      group: newGroup,
    };

  } catch (error) {
    console.error('AI processing failed:', error);
    return { message: 'Failed to process group link. Please check the link and try again.' };
  }
}
